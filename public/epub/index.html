<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>epub</title>
    <style>
        html, body, #area {
            height: 100%;
            width: 100%
        }
    </style>
</head>
<body>
<div id="area"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
<script src="https://unpkg.com/epubjs@0.3.93/dist/epub.min.js"></script>
<script type="module">
    const epubUrl = new URL(location.href).searchParams.get("file");
    const search = new URL(location.href).searchParams.get("search");
    console.log("epubUrl", epubUrl)
    const book = ePub(epubUrl);
    const rendition = book.renderTo("area", {
        width: "100%",
        height: "100%",
        manager: "continuous",
        flow: "scrolled",
    });
    const displayed = await rendition.display();

    function doSearch(q) {
        return Promise.all(
            book.spine.spineItems
                .map(item => {
                    return item.load(book.load.bind(book))
                        .then(item.find.bind(item, q))
                        .finally(item.unload.bind(item))
                })
        ).then(results => {
            return results.flat();
        });
    }

    await book.ready.then();
    console.log("ready")
    if (doSearch) {
        const items = await doSearch(search);
        console.log("found items", items);
        // highlight
        items.forEach(item => {
            rendition.annotations.highlight(item.cfi, {}, (e) => {
                console.log("highlight clicked", e.target);
            });
        })
        console.log("move to first");
        rendition.display(items[0].cfi);
    }

</script>
</body>
</html>
